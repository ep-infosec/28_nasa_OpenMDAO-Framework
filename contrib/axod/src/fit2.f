C           SUBROUTINE FIT2
      SUBROUTINE FIT2
      REAL MFSTOP
      LOGICAL PREVER
      COMMON /SNTCP/G,AJ,PRPC,ICASE,PREVER,MFSTOP,JUMP,LOPIN,ISCASE,
     1KN,GAMF,IP,SCRIT,PTRN,ISECT,KSTG,WTOL,RHOTOL,PRTOL,TRLOOP,LSTG,
     2LBRC,IBRC,ICHOKE,ISORR,CHOKE,PT0PS1(6,8),PTRS2(6,8),TRDIAG,SC,RC,
     3DELPR,PASS,IPC,LOPC,ISS
C
      COMMON/GEBE/DRBARR,DRBARS,E1,E2,E3,E4,E5,E6,HBRRH,HBRSH,IAFE
     1,IALF,IBT2,ICPR,ICPS,ISR2,ISTR,ISTS,L,R1,R3,R4,R5,
     2TALF,WGT0(8),WT(7),HBARS,HBARR,I
C
      COMMON /SINIT/H1(6,8),H2(6,8),DP0(6,8),DP1(6,8),DP1A(6,8),DP2(6,8)
     1,DP2A(6,8),CSALF1(6,8),ALF1(6,8),CSBET2(6,8),BET2(6,8),RADSD(6,8),
     2RADRD(6,8),ANN1(6,8),ANN2(6,8),ANN2A(6,8),ANN1A(6,8),U1A(6,8),
     3U2(6,8),ANN0(6,8),PT0(6,8),TT0(6,8),ALPHA0(6,8),PTP(6,8)
C
      COMMON /SINPUT/
     1PTPS,PTIN,TTIN,WAIR,FAIR,DELC,DELL,DELA,AACS,VCTD,STG,SECT,EXPN,
     2EXPP,EXPRE,RG,RPM,PAF,SLI,STGCH,ENDJOB,XNAME(20),TITLE(20),
     3PCNH(6),GAM(6,8),DR(6,8),DT(6,8),RWG(6,8),ALPHAS(6,8),ALPHA1(6,8),
     4ETARS(6,8),ETAS(6,8),CFS(6,8),ANDO(6,8),BETA1(6,8),BETA2(6,8),ETAR
     5R(6,8),ETAR(6,8),CFR(6,8),TFR(6,8),ANDOR(6,8),OMEGAS(6,8),AS0(6,8)
     6,ASMP0(6,8),ACMN0(6,8),A1(6,8),A2(6,8),A3(6,8),A4(6,8),A5(6,8),A6(
     76,8),OMEGAR(6,8),BSIA(6,8),BSMPIA(6,8),BCMNIA(6,8),B1(6,8),B2(6,8)
     8,B3(6,8),B4(6,8),B5(6,8),B6(6,8),SESTHI(8),RERTHI(8)
     9,fairx(5,8),wairx(5,8),rg1(8),rg1a(8),rg2(8),rg2a(8)
C
      REAL M0
      COMMON /SSTA01/CP0(8),w0(6),               PS0(6,8),V0(6,8),TS0(6,
     18),VU0(6,8),VZ0(6,8),RHOS0(6,8),PS1(6,8),WGT1(8),TA1(8),WG1(6,8),
     2            DPDR1(6,8),SI(6,8),  CP1(8),PHI1(6,8),TS1(6,8),V1(6,8)
     3,RHOS1(6,8),ALF1E(6,8),VU1(6,8),VZ1(6,8),M0(6,8)
C
      REAL MR1A
      COMMON /SSTA1A/VU1A(6,8),WG1A(6,8),WGT1A(8),VZ1A(6,8),  CP1A(8),
     1PS1A(6,8),RU1A(6,8),R1A(6,8),BET1A(6,8),RI(6,8),TTR1A(6,8),PTR1A(6
     2,8),MR1A(6,8)
C
      COMMON /SSTA2/V2(6,8),TTR2(6,8),PTR2(6,8),WG2(6,8),WGT2(8),TA2(8),
     1           PS2(6,8),PHI2(6,8)
C
      REAL MR2,M2     ,MF2
      COMMON /SFLOW2/TS2(6,8),CP2(8),R2(6,8),RHOS2(6,8),BET2E(6,8),RU2(6
     1,8),VU2(6,8),DPDR2(6,8),VZ2(6,8),MR2(6,8),MF2(6,8),M2(6,8)
C
      REAL M2A,MF2A
      COMMON /SSTA2A/WG2A(6,8),WGT2A(8),VU2A(6,8),VZ2A(6,8),PS2A(6,8),
     1ALF2A(6,8),TT2A(6,8),PT2A(6,8),TTBAR(8),PTBAR(8),STT0(8),SPT0(8),
     2M2A(6,8),MF2A(6,8),CP2A(8),V2A(6,8),TS2A(6,8),TAS(8),PAS(8),GAMS(8
     3),CPO(8),DELHVD(6,8)
C
      COMMON /SOVRAL/DELHT(6,8),DELHTI(6,8),DELHSI(6,8),DEHATI(6,8),
     1ETATT(6,8),ETATS(6,8),ETATAT(6,8),delhtu(6,8)
C
      COMMON /BDINST/
     1IFMI01(4),IFMI02(4),IFMI03(4),IFMI04(4),IFMI05(4),IFMI06(4),
     2IFMI07(4),IFMI08(4),IFMI09(4),IFMI10(4),IFMI11(4),IFMI12(4),
     3IFMI13(4),IFMI14(4),IFMI15(4),IFMI16(4),IFMI17(4),IFMI18(4),
     4IFMI19(4),IFMI20(4),IFMI21(4),IFMI22(4),IFMI23(4),IFMI24(4),
     5IFMI25(4),IFMI26(4),IFMI27(4),IFMI28(4),IFMI29(4),IFMI30(4),
     6IFMI31(4),IFMI32(4),IFMI33(4),IFMI34(4),IFMI35(4),IFMI36(4),
     7IFMI37(4),IFMI38(4),IFMI39(4),IFMI40(4),IFMI41(4),IFMI42(4),
     8IFMI43(4),IFMI44(4),IFMI45(4),IFMI46(4),IFMI47(4),IFMI48(4),
     9IFMI49(4),IFMI50(4),IFMI51(4),IFMI52(4),IFMI53(4),IFMI54(4),
     1IFMI55(4),IFMI56(4),IFMI57(4),IFMI58(4),IFMI59(4),IFMI60(4),
     2IFMI61(4)
C
      COMMON  /C1FIT1/STDP0(7),STTT0(7),STPT0(7),STALF(7)
     1,STSI(7),STV0(7),STVU0(7),STVZ0(7),STTS0(7),
     2STPS0(7),STDEN0(7),STM0(7),STDP1(7),STTT1(7),
     3STALFE(7),STDELA(7),STV1(7),STVU1(7),STVZ1(7),
     4STTS1(7),STPS1(7),STDEN1(7),STM1(7),ZWIINC(7),
     5CPS(7),STDP1A(7),STTTR1(7),STPTR1(7),STBET1(7),
     6STRI(7),STR1A(7),STRU1A(7),STMR1A(7),STU1A(7),
     7STDP2(7),STBET2(7),SDBETA(7),SR2(7),SRU2(7),
     8SMR2(7),SU2(7),RX(7),STDELH(7),STPSI(7),
     9SETATT(7),SETATS(7),SETAAT(7),RZWINC(7),CPR(7),
     1STDP2A(7),STPT2(7),STTT2(7),STV2(7),STVU2(7),
     2STALF2(7),STMF2(7),STVZ2(7),STTS2(7),STPS2(7),
     3STDEN2(7),STM2(7),lj,jj,K
C
      COMMON   /C2FIT1/DBARS(7),FTANS(7),FAXS(7),DBARR(7),
     1FTANR(7),FAXR(7)
      COMMON RES(8),DALF(6),DSTS(6),DALFE(6),DCPS(6),DSTR(6),
     *DBT2(6),DCPR(6),DSR2(6)
      COMMON/TPT1/PT1(6),TT1(6,8)
      COMMON/DESOPT/RVU1(6,8),RVU2(6,8),WG,EPR
      dimension tangms(6,8),tangmr(6,8),tangm1(6,8),tangm2(6,8),tang0(6)
      common/slope/tangms,tangmr,tangm1,tangm2,tang0,iar,icyl
C
      DIMENSION IFMI1(4,61),Y(7,61)
      EQUIVALENCE (IFMI1(1,1),IFMI01(1)),(Y(1,1),STDP0(1))
C
C
      DATA DOR/57.29578/
C        STATION    0        STATOR  INLET
C                              
C                                                     
      STTT0(L)=TT0(I,K)
      STPT0(L)=PTP(I,K)
      STVZ0(L)=VZ0(I,K)
      STVU0(L)=VU0(I,K)*R1
      STV0(L)=SQRT(VZ0(I,K)*VZ0(I,K)+STVU0(L)*STVU0(L))
      STTS0(L)=TT0(I,K)-STV0(L)*STV0(L)/(2.*G*AJ*CP0(K))
      STPS0(L)=PS0(I,K)*(STTS0(L)/TS0(I,K))**E2
      rg0=rg
      if (k.gt.1) rg0=rg2a(k-1)
      STDEN0(L)=144.*STPS0(L)/(rg0*STTS0(L))
      STALF(L)=0.
      STSI(L)=0.
      DRP=1.
      DO 200 ID=1,ISECT
      IF(ID.GT.IALF)GO TO 210
      STALF(L)=STALF(L)+DALF(ID)*DRP*DOR
210   IF(ID.GT.ISTS)GO TO 200
      STSI(L)=STSI(L)+DSTS(ID)*DRP*DOR
200   DRP=DRP*STDP0(L)
      STVZ0(L)=STV0(L)*COS(STALF(L)/57.29578)
      STVU0(L)=STV0(L)*SIN(STALF(L)/57.29578)
      AS0H=SQRT(GAM(1,K)*G*rg0*STTS0(L))
      STM0(L)=STV0(L)/AS0H
C        STATION    1        STATOR  EXIT
      STTT1(L)=TT1(I,K)
      STVZ1(L)=VZ1(I,K)
      STVU1(L)=VU1(I,K)*R2(1,1)
      STV1(L)=SQRT(VZ1(I,K)*VZ1(I,K)+STVU1(L)*STVU1(L))
      STTS1(L)=TT0(I,K)-STV1(L)*STV1(L)/(2.*G*AJ*CP1(K))
      STPS1(L)=PS1(I,K)*(STTS1(L)/TS1(I,K))**E3
      STDEN1(L)=144.*STPS1(L)/STTS1(L)/rg1(k)
      DRP=1.
      STALFE(L)=0.
      CPS(L)=0.
      DO 220 ID=1,ISECT
      IF(ID.GT.IAFE)GOTO 230
      STALFE(L)=STALFE(L)+DALFE(ID)*DRP*DOR
230   IF(ID.GT.ICPS)GO TO 220
      CPS(L)=CPS(L)+DCPS(ID)*DRP
220   DRP=DRP*STDP1(L)
      STVZ1(L)=STV1(L)*COS(STALFE(L)/57.29578)
      STVU1(L)=STV1(L)*SIN(STALFE(L)/57.29578)
      STDELA(L)=STALF(L)+STALFE(L)
      AS1H=SQRT(GAM(2,K)*G*rg1(k)*STTS1(L))
      STM1(L)=STV1(L)/AS1H
      ZS =-2.*STALFE(L)/ 57.2958 -1.570796
      ZWIINC(L)=-2.*COS(ZS)/(1.+ANN0(I,  K)/ANN1(I,  K))
     1*(STVU0(L )*STVZ1(L )/STVZ0(L )/STVU1(L )
     2*ANN1(I,  K)/ANN0(I,  K)+1.)
C        STATION   1A        ROTOR    INLET
      VU1AH=STVU1(L)*STDP1(L)/STDP1A(L)
      VZ1AH=STVZ1(L)*ANN1(I,K)/ANN1A(I,K)
      STRU1A(L)=VU1AH-U1A(I,K)/R3
      STBET1(L)=57.29578*ATAN(STRU1A(L)/VZ1AH)
      T=TALF-(TALF/R3 - SIN(RADRD(I,K))/COS(RADRD(I,K)))/R3
      DRP=1.
      STRI(L)=0.
      DO 240 ID=1,ISTR
      STRI(L)=STRI(L)+DSTR(ID)*DRP*DOR
240   DRP=DRP*STDP1A(L)
      STR1A(L)=SQRT(STRU1A(L)**2+VZ1AH**2)
      V1A1AH=VZ1AH**2+VU1AH**2
      DELTSH=(V1(I,K)*V1(I,K)-V1A1AH)/(2.*G*AJ*CP1A(K))
      TS1AH=TS1(I,K)+DELTSH
      STMR1A(L)=STR1A(L)/SQRT(GAM(3,K)*G*rg1a(k)*TS1AH)
      TTRSH=1.+STMR1A(L)*STMR1A(L)*(GAM(3,K)-1.)/2.
      STTTR1(L)=TS1AH*TTRSH
C     IF (RI(I,K))2,2,7
C     replaced by ........
      IF (RI(I,K).LE.0) THEN
         EXPRI=EXPN
C        GO TO 2
      ELSE
         EXPRI=EXPP
C        GO TO 7
      ENDIF
C                           
C2     EXPRI=EXPN
C     GO TO 11
C7     EXPRI=EXPP
11    PTRSH=(1.+(TTRSH-1.)*ETARR(I,K)*COS(RI(I,K))**EXPRI)**E4
      PS1AH=PS1(I,K)*(1.+DELTSH/TS1(I,K))**E4
      STPTR1(L)=PS1AH*PTRSH
      STU1A(L)=U1A(I,K)/R3
C        STATION    2        ROTOR    EXIT
      VU2H=VU2(I,K)*R4
      V2V2H=VZ2(I,K)*VZ2(I,K)+VU2H*VU2H
      SU2(L)=U2(I,K)/R4
      DRP=1.
      STBET2(L)=0.
      R2EX=0.
      CPR(L)=0.
      DO 250 ID=1,ISECT
      IF(ID.GT.IBT2)GO TO 260
      STBET2(L)=STBET2(L)+DBT2(ID)*DRP*DOR
260   IF(ID.GT.ICPR)GO TO 270
      CPR(L)=CPR(L)+DCPR(ID)*DRP
270   IF(ID.GT.ISR2)GO TO 250
      R2EX=R2EX+DSR2(ID)*DRP
250   DRP=DRP*STDP2(L)
C     IF ((SU2(L)*COS(STBET2(L)/DOR))**2-V2V2H) 320,320,310
C310   STBET2(L)= DOR*STBET2(L)/ABS(STBET2(L))*ATAN(SQRT(SU2(L)**2
C     1/V2V2H-1.))
C320   U2SNB2=SU2(L)*SIN(STBET2(L)/DOR)
C     replaced by ..........
      IF ((SU2(L)*COS(STBET2(L)/DOR))**2-V2V2H .GT.0.) THEN 
         STBET2(L)= DOR*STBET2(L)/ABS(STBET2(L))*ATAN(SQRT(SU2(L)**2
     1/V2V2H-1.))
      ENDIF
      U2SNB2=SU2(L)*SIN(STBET2(L)/DOR)
      SGNDF=R2EX-U2SNB2
      SR2(L)=U2SNB2+SGNDF/ABS(SGNDF)*SQRT(ABS(V2V2H-(SU2(L)
     1*COS(STBET2(L)/57.29578))**2+.0001))
      SRU2(L)=SR2(L)*SIN(STBET2(L)/57.29578)
      VZ2H=SR2(L)*COS(STBET2(L)/57.29578)
      VU2H=SRU2(L)-SU2(L)
      SDBETA(L)=STBET1(L)+STBET2(L)
      DELTSH=(V2(I,K)*V2(I,K)-V2V2H)/(2.*G*AJ*CP2(K))
      TS2H=TS2(I,K)+DELTSH
      SMR2(L)=SR2(L)/SQRT(GAM(4,K)*G*rg2(k)*TS2H)
      PS2H=PS2(I,K)*(TS2H/TS2(I,K))**E5
      RX(L)=1.-(1.-(STPS1(L)/PTP(I,K))**E1)/(1.-(PS2H/PTP(I,K))**E1)
      STDELH(L)=(STU1A(L)*VU1AH+SU2(L)*VU2H)*TFR(I,K)/(   G*AJ)
      STPSI(L)=   G*AJ*STDELH(L)/(STU1A(L)**2+SU2(L)**2)
      SETATT(L)=STDELH(L)/DELHTI(I,K)
      SETATS(L)=STDELH(L)/DELHSI(I,K)
      SETAAT(L)=STDELH(L)/DEHATI(I,K)
      ZR =-2.*STBET2(L)/57.2958 -1.570796
      RZWINC(L )=-2.*COS(ZR)/(1.+ANN1A(I,  K)/ANN2(I,  K))*
     2(STRU1A(L )*VZ2(I,  K)/VZ1(I,  K)/SRU2(L )
     2*ANN2(I,  K)/ANN1A(I,  K)+1.)
      STPT2(L)=PT2A(I,K)
      STTT2(L)=TT2A(I,K)
      STVZ2(L)=VZ2H*ANN2(I,K)/ANN2A(I,K)
      STVU2(L)=VU2H*STDP2(L)/STDP2A(L)
      V2A2AH=STVU2(L)**2+STVZ2(L)**2
      STV2(L)=SQRT(V2A2AH)
      STALF2(L)=ATAN2(STVU2(L),STVZ2(L))*57.29578
      DELTS2=(V2A(I,K)**2-V2A2AH)/(2.*G*AJ*CP2A(K))
      STTS2(L)=TS2A(I,K)+DELTS2
      STPS2(L)=PS2A(I,K)*(1.+DELTS2/TS2A(I,K))**E6
      STDEN2(L)=144.*STPS2(L)/(rg2(k)*STTS2(L))
      STM2(L)=STV2(L)/SQRT(GAM(4,K)*G*rg2(k)*STTS2(L))
      STMF2(L)=STM2(L)*COS(STALF2(L)/57.2958)
      DBARS(L )=DRBARS+HBRSH*(STDP1(L )-DR(2,K))*2.0
      HBRS=H1(I  ,K)*HBRSH*2.
      HBRR=H2(I  ,K)*HBRRH*2.

C array index error here 12/10/03 RWC
      if (k.eq.1) then
          ll=l
          if(l.gt.6) then 
            ll=1
          endif
        cat0=cos(atan(tang0(ll)))
      else
          ll=l
          if(l.gt.6) ll=1
        cat0=cos(atan(tangm2(ll,k-1)))
      end if

      cat1=cos(atan(tangm1(ll,k)))
      cat2=cos(atan(tangm2(ll,k)))
      FAXS(L )=((STPS0(L )-STPS1(L ))*(ANN1(I  ,K) +ANN0(I  ,K))*72.
     1+WG1(I  ,K)/G*(STVZ0(L )*cat0-STVZ1(L )*cat1))/HBRS
      FTANS(L )=-WG1(I  ,K)*(STDP1(L )*STVU1(L )+STDP0(L )
     1*STVU0(L ))/DBARS(L )/G/HBRS
      DBARR(L )=DRBARR+HBRRH*(STDP2(L )-DR(4,K))*2.0
      FTANR(L)=WG2(I,K)*(STDP2A(L)*VU2H+STDP1(L)*VU1AH)
     1/DBARR(L )/G/HBRR*TFR(I  ,K)
      FAXR(L)=((PS1AH-PS2H)*(ANN1A(I,K)+ANN2(I,K))*72.+
     1WG2(I,K)/G*(VZ1AH*cat1-VZ2H*cat2))/HBRR
      RETURN
      END
